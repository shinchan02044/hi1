<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Happy 24th Birthday Rishab</title>
<style>
  body, html{margin:0; padding:0; height:100%; overflow:hidden; font-family:'Times New Roman', serif;}
  body{background:linear-gradient(to top, #1a1f4b, #ff9966);}
  h1{position:absolute; top:20px; width:100%; text-align:center; color:white; font-size:3em; text-shadow:2px 2px 10px rgba(0,0,0,0.7); z-index:5;}
  
  /* Star canvas */
  #starsCanvas {
    position: fixed;
    inset: 0;
    z-index:0;
    pointer-events:none;
  }

  /* Rooftop and candle */
  #rooftop-scene{position:fixed; inset:0; background:url('rooftop-4k.jpg') center/cover no-repeat; display:flex; justify-content:center; align-items:flex-end; z-index:1;}
  .candle-wrap{position:absolute; bottom:120px; display:flex; flex-direction:column; align-items:center; z-index:2;}
  .candle{width:40px; height:110px; background:linear-gradient(#fff,#ffd9b3); border-radius:8px; position:relative; display:flex; align-items:flex-start; justify-content:center; cursor:pointer;}
  .wick{width:4px; height:18px; background:#333; margin-top:8px; border-radius:6px;}
  .flame{position:absolute; top:-14px; width:18px; height:28px; border-radius:50%; filter:drop-shadow(0 8px 12px rgba(255,140,0,0.45)); transition:all .35s ease;}
  .flame::before{content:''; position:absolute; left:4px; top:4px; width:10px; height:16px; border-radius:50%; background:orange;}
  .flame::after{content:''; position:absolute; left:6px; top:8px; width:6px; height:10px; border-radius:50%; background:yellow;}
  .extinguished .flame{opacity:0; transform:translateY(-6px) scale(0.2);}

  /* Letter modal */
  #letterModal{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:1001;}
  .letter-content {
    width:842px;
    max-width:95%;
    max-height:90%;
    aspect-ratio:1/1.414;
    padding:0;
    border-radius:6px;
    display:flex;
    justify-content:center;
    align-items:center;
    overflow:hidden;
    position:relative;
    z-index:1002;
    background:white;
  }
  .letter-content div {
    width:100%;
    height:100%;
    overflow-y:auto;
  }
  .close-btn{position:absolute; top:10px; right:10px; background:transparent; border:none; font-size:24px; cursor:pointer; color:black; z-index:1010;}

  /* Night scene */
  #nightScene{position:fixed; inset:0; display:none; background:url('night-rooftop-4k.jpg') center/cover no-repeat; z-index:1;}
  
  /* Video as background music */
  #bgMusic{position:fixed; bottom:10px; right:10px; width:120px; height:auto; z-index:3; display:block;}
</style>
</head>
<body>

<h1>Happy Birthday Rishabh</h1>

<!-- Star canvas -->
<canvas id="starsCanvas"></canvas>

<!-- Rooftop and candle -->
<div id="rooftop-scene">
  <div class="candle-wrap">
    <div class="candle" id="candle">
      <div class="wick"></div>
      <div class="flame" id="flame"></div>
    </div>
    <p style="color:white; text-shadow:1px 1px 5px rgba(0,0,0,0.5); margin-top:12px;">
      Blow the candle or double click it to reveal your letter ✨
    </p>
  </div>
</div>

<!-- Letter popup -->
<div id="letterModal">
  <div class="letter-content">
    <button class="close-btn" id="closeLetter">✕</button>
    <div>
      <img src="pic1.jpg" style="width:100%; object-fit:contain; display:block;" />
    </div>
  </div>
</div>

<!-- Night rooftop -->
<div id="nightScene">
  <canvas id="nightStarsCanvas"></canvas>
</div>

<!-- Video as background music -->
<video id="bgMusic" src="vid1.mp4" poster="pic1.jpg" loop controls></video>

<script>
const candle = document.getElementById('candle');
const flame = document.getElementById('flame');
const letterModal = document.getElementById('letterModal');
const closeLetter = document.getElementById('closeLetter');
const nightScene = document.getElementById('nightScene');
const audio = document.getElementById('bgMusic');

let clickCount = 0;
let listening = false;
let audioContext, analyser, source;
let blowCooldown = false;

// Microphone blow detection
async function startListening(){
  if(listening) return;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioContext = new (window.AudioContext||window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    source = audioContext.createMediaStreamSource(stream);
    source.connect(analyser);
    analyser.fftSize = 128;
    const data = new Uint8Array(analyser.frequencyBinCount);
    listening = true;

    const check = () => {
      analyser.getByteTimeDomainData(data);
      let sum=0;
      for(let i=0;i<data.length;i++){
        const v=(data[i]-128)/128;
        sum+=v*v;
      }
      const rms=Math.sqrt(sum/data.length);
      if(rms>0.08 && !blowCooldown && !candle.classList.contains('extinguished')){
        extinguishCandle();
        blowCooldown=true;
        setTimeout(()=>blowCooldown=false,1500);
      }
      if(listening) requestAnimationFrame(check);
    };
    check();
  }catch(e){alert('Microphone access denied.');}
}

// Extinguish candle and open letter
function extinguishCandle(){
  candle.classList.add('extinguished');
  letterModal.style.display='flex';
  audio.play().catch(()=>{});
}

// Candle click/double-click
candle.addEventListener('click', ()=>{
  clickCount++;
  if(clickCount>=2 && !candle.classList.contains('extinguished')){
    extinguishCandle();
    clickCount=0;
  } else {
    startListening();
  }
});

// Close letter
closeLetter.addEventListener('click', ()=>{
  letterModal.style.display='none';
  candle.classList.remove('extinguished');
  clickCount=0;
  nightScene.style.display='block';
  startNightStars();
});

// Star animation for main page
function startStarAnimation(){
  const canvas = document.getElementById('starsCanvas');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const ctx = canvas.getContext('2d');
  const stars = [];
  for(let i=0;i<200;i++){
    stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*1.5, twinkle: Math.random()*0.05});
  }
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    stars.forEach(s=>{
      s.r += (Math.random()-0.5)*s.twinkle;
      if(s.r<0.2) s.r=0.2;
      if(s.r>1.5) s.r=1.5;
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fillStyle='white';
      ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  draw();
}

// Star animation for night scene after candle blown
function startNightStars(){
  const canvas = document.getElementById('nightStarsCanvas');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const ctx = canvas.getContext('2d');
  const stars = [];
  for(let i=0;i<200;i++){
    stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*1.5, twinkle: Math.random()*0.05});
  }
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    stars.forEach(s=>{
      s.r += (Math.random()-0.5)*s.twinkle;
      if(s.r<0.2) s.r=0.2;
      if(s.r>1.5) s.r=1.5;
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fillStyle='white';
      ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  draw();
}

// Start main stars immediately
startStarAnimation();
</script>
</body>
</html>
